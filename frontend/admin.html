<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel - Dnyandeep Mahavidyalay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="dist/output.css" rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f0eb;
        color: #2d2926;
        display: flex;
        min-height: 100vh;
        margin: 0;
      }
      nav.sidebar {
        width: 220px;
        background-color: #7b1f24;
        color: #fbeee6;
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
      }
      nav.sidebar h2 {
        margin-bottom: 1rem;
        font-weight: 700;
        font-size: 1.5rem;
        text-align: center;
      }
      nav.sidebar button {
        background: transparent;
        border: none;
        color: inherit;
        text-align: left;
        padding: 0.75rem 1rem;
        margin-bottom: 0.4rem;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 0.25rem;
        transition: background-color 0.3s ease;
      }
      nav.sidebar button:hover,
      nav.sidebar button.active {
        background-color: #e76f51;
        color: #fff;
      }
      main.content {
        flex-grow: 1;
        padding: 2rem 3rem;
        background: #fff;
        overflow-y: auto;
      }
      input,
      textarea {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 0.3rem;
        border: 1px solid #e3afa2;
        font-size: 1rem;
      }
      button.btn-primary {
        background-color: #ff7043;
        color: #fff;
        padding: 0.7rem 1.2rem;
        font-weight: 600;
        border: none;
        border-radius: 0.35rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button.btn-primary:disabled {
        background-color: #ffa07a;
        cursor: not-allowed;
      }
      button.btn-primary:hover:enabled {
        background-color: #e74a28;
      }
      .notice-item {
        background: #fbeee6;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 6px rgba(231, 111, 81, 0.1);
        margin-bottom: 1rem;
        position: relative;
      }
      .notice-title {
        font-weight: 700;
        color: #7b1f24;
        font-size: 1.15rem;
        margin-bottom: 0.4rem;
      }
      .notice-date {
        font-style: italic;
        font-size: 0.85rem;
        color: #8d796f;
        margin-bottom: 0.5rem;
      }
      .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #e74a28;
        border: none;
        color: white;
        padding: 0.3rem 0.7rem;
        border-radius: 0.3rem;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.3s ease;
      }
      .delete-btn:hover {
        background-color: #a71d2a;
      }
      #events-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }
      .event-image-wrapper {
        border-radius: 0.5rem;
        box-shadow: 0 1px 6px rgba(231, 111, 81, 0.1);
        overflow: hidden;
        cursor: default;
        background: #fff;
        padding: 0.5rem;
        position: relative;
        text-align: center;
      }
      .event-image-wrapper img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
        border-radius: 0.5rem;
      }
      .event-delete-btn {
        margin-top: 0.5rem;
        background: #e74a28;
        border: none;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 0.3rem;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.3s ease;
        width: 70%;
      }
      .event-delete-btn:hover {
        background-color: #a71d2a;
      }
      #section-admissions p {
        font-style: italic;
        color: #7b1f24;
      }
      /* Notification Styles */
      .notification {
        max-width: 600px;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.35rem;
        font-weight: 600;
        color: white;
        display: none;
      }
      .notification-success {
        background-color: #4caf50;
      }
      .notification-error {
        background-color: #f44336;
      }
    </style>
  </head>
  <body>
    <nav class="sidebar" aria-label="Admin Navigation">
      <h2>Admin Panel</h2>
      <button
        id="nav-notices"
        class="active"
        aria-controls="section-notices"
        aria-selected="true"
        type="button"
      >
        Notices
      </button>
      <button
        id="nav-events"
        aria-controls="section-events"
        aria-selected="false"
        type="button"
      >
        Event Gallery
      </button>
      <button
        id="nav-admissions"
        aria-controls="section-admissions"
        aria-selected="false"
        type="button"
      >
        Admission Enquiries
      </button>
      <!-- Logout button -->
      <button
        id="btn-logout"
        type="button"
        style="
          margin-top: auto;
          background: transparent;
          border: none;
          color: #fbeee6;
          padding: 0.75rem 1rem;
          cursor: pointer;
          font-size: 1rem;
          border-radius: 0.25rem;
          transition: background-color 0.3s ease;
        "
      >
        Logout
      </button>
    </nav>
    <main class="content">
      <!-- Notices Section -->
      <section
        id="section-notices"
        class="admin-section"
        role="tabpanel"
        aria-labelledby="nav-notices"
      >
        <h1>Manage Notices</h1>

        <!-- Notice Notifications -->
        <div
          id="notice-notification"
          class="notification"
          role="alert"
          aria-live="assertive"
        ></div>

        <form
          id="notice-form"
          aria-label="Add new notice"
          autocomplete="off"
          style="max-width: 600px; margin-bottom: 2rem"
        >
          <input
            type="text"
            id="notice-title"
            name="title"
            placeholder="Title"
            required
          />
          <textarea
            id="notice-description"
            name="description"
            placeholder="Description"
            required
            rows="4"
          ></textarea>
          <input type="date" id="notice-date" name="date" required />
          <button type="submit" class="btn-primary">Add Notice</button>
        </form>
        <div
          id="notices-list"
          aria-live="polite"
          aria-relevant="additions removals"
        ></div>
      </section>

      <!-- Event Gallery Section -->
      <section
        id="section-events"
        class="admin-section"
        role="tabpanel"
        aria-labelledby="nav-events"
        hidden
      >
        <h1>Manage Event Gallery</h1>

        <!-- Event Notifications -->
        <div
          id="event-notification"
          class="notification"
          role="alert"
          aria-live="assertive"
        ></div>

        <!-- Upload form -->
        <form
          id="event-upload-form"
          style="max-width: 400px; margin-bottom: 2rem"
          autocomplete="off"
          enctype="multipart/form-data"
        >
          <input
            type="text"
            id="event-title"
            name="title"
            placeholder="Event Title"
            required
          />
          <input type="date" id="event-date" name="date" required />
          <input
            type="file"
            id="event-image"
            name="image"
            accept="image/*"
            required
          />
          <button type="submit" class="btn-primary">Upload Event Image</button>
        </form>
        <div
          id="events-gallery"
          aria-live="polite"
          aria-relevant="additions removals"
        ></div>
      </section>

      <!-- Admission Enquiries Section -->
      <section
        id="section-admissions"
        class="admin-section"
        role="tabpanel"
        aria-labelledby="nav-admissions"
        hidden
      >
        <h1>Admission Enquiries</h1>
        <p>Coming soon: view and manage admission enquiries.</p>
      </section>
    </main>
    <script>
      const BACKEND_URL = "http://localhost:3000";

      // Redirect if no token is found
      const token = localStorage.getItem("adminToken");
      if (!token) {
        window.location.href = "/admin-login.html";
      }

      // Sidebar navigation handling
      const navButtons = document.querySelectorAll("nav.sidebar button");
      const adminSections = document.querySelectorAll(
        "main.content .admin-section"
      );
      function setActiveSection(id) {
        adminSections.forEach(
          (section) => (section.hidden = section.id !== id)
        );
        navButtons.forEach((btn) => {
          const selected = btn.getAttribute("aria-controls") === id;
          btn.classList.toggle("active", selected);
          btn.setAttribute("aria-selected", selected);
        });
        if (id === "section-events") loadEvents();
      }
      navButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const target = button.getAttribute("aria-controls");
          setActiveSection(target);
        });
      });
      setActiveSection("section-notices");

      // Show notification utility
      function showNotification(
        elementId,
        message,
        isSuccess = true,
        timeout = 4000
      ) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = isSuccess
          ? "notification notification-success"
          : "notification notification-error";
        el.style.display = "block";

        setTimeout(() => {
          el.style.display = "none";
          el.textContent = "";
        }, timeout);
      }

      // Auth error checker
      function checkAuthError(response) {
        if (response.status === 401 || response.status === 403) {
          alert("Session expired or unauthorized access. Please login again.");
          localStorage.removeItem("adminToken");
          window.location.href = "/admin-login.html";
          return true;
        }
        return false;
      }

      // --- Notices Section ---
      const noticeForm = document.getElementById("notice-form");
      const noticesList = document.getElementById("notices-list");

      async function loadNotices() {
        noticesList.innerHTML = "<p>Loading...</p>";
        try {
          const res = await fetch(`${BACKEND_URL}/api/notices`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (checkAuthError(res)) return;
          const notices = await res.json();
          if (notices.length === 0) {
            noticesList.innerHTML = "<p>No notices found.</p>";
            return;
          }
          noticesList.innerHTML = "";
          notices.forEach((notice) => {
            const div = document.createElement("div");
            div.className = "notice-item";
            div.innerHTML = `
              <div class="notice-title">${notice.title}</div>
              <div class="notice-date">${notice.date}</div>
              <div>${notice.description}</div>
              <button class="delete-btn" aria-label="Delete notice titled ${notice.title}" data-id="${notice._id}">Delete</button>
            `;
            noticesList.appendChild(div);
          });
          // Add delete handlers to buttons
          noticesList.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              if (confirm("Are you sure you want to delete this notice?")) {
                const id = btn.dataset.id;
                try {
                  const resp = await fetch(`${BACKEND_URL}/api/notices/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` },
                  });
                  if (checkAuthError(resp)) return;
                  if (!resp.ok) throw new Error("Failed to delete notice");
                  showNotification(
                    "notice-notification",
                    "Notice deleted successfully."
                  );
                  loadNotices();
                } catch (error) {
                  showNotification(
                    "notice-notification",
                    "Error deleting notice.",
                    false
                  );
                }
              }
            });
          });
        } catch (err) {
          console.error("Error loading notices:", err);
          noticesList.innerHTML = "<p>Error loading notices.</p>";
        }
      }

      noticeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = noticeForm.title.value.trim();
        const description = noticeForm.description.value.trim();
        const date = noticeForm.date.value;
        if (!title || !description || !date) {
          showNotification(
            "notice-notification",
            "Please fill out all fields.",
            false
          );
          return;
        }

        const submitBtn = noticeForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        try {
          const resp = await fetch(`${BACKEND_URL}/api/notices`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ title, description, date }),
          });
          if (checkAuthError(resp)) return;
          if (!resp.ok) throw new Error("Failed to add notice");
          noticeForm.reset();
          showNotification("notice-notification", "Notice added successfully.");
          loadNotices();
        } catch (err) {
          console.error("Error adding notice:", err);
          showNotification(
            "notice-notification",
            "Failed to add notice. Please try again.",
            false
          );
        } finally {
          submitBtn.disabled = false;
        }
      });

      // --- Events Section ---
      const eventsGallery = document.getElementById("events-gallery");
      async function loadEvents() {
        eventsGallery.innerHTML = "<p>Loading event images...</p>";
        try {
          const response = await fetch(`${BACKEND_URL}/api/events`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (checkAuthError(response)) return;
          if (!response.ok) throw new Error("Failed to load events");
          const events = await response.json();
          if (events.length === 0) {
            eventsGallery.innerHTML = "<p>No event images available.</p>";
            return;
          }
          eventsGallery.innerHTML = "";
          events.forEach((event) => {
            const imgWrapper = document.createElement("div");
            imgWrapper.setAttribute("tabindex", "0");
            imgWrapper.setAttribute("role", "img");
            imgWrapper.setAttribute("aria-label", event.title || "Event image");
            imgWrapper.className = "event-image-wrapper";

            const img = document.createElement("img");
            img.src = event.imageUrl;
            img.alt = event.title || "Event image";
            imgWrapper.appendChild(img);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "event-delete-btn";
            deleteBtn.onclick = async () => {
              if (
                confirm("Are you sure you want to delete this event image?")
              ) {
                try {
                  const delResp = await fetch(
                    `${BACKEND_URL}/api/events/${event._id}`,
                    {
                      method: "DELETE",
                      headers: { Authorization: `Bearer ${token}` },
                    }
                  );
                  if (checkAuthError(delResp)) return;
                  if (!delResp.ok) throw new Error("Failed to delete event");
                  showNotification(
                    "event-notification",
                    "Event deleted successfully."
                  );
                  loadEvents();
                } catch (error) {
                  showNotification(
                    "event-notification",
                    "Error deleting event.",
                    false
                  );
                }
              }
            };
            imgWrapper.appendChild(deleteBtn);

            eventsGallery.appendChild(imgWrapper);
          });
        } catch (error) {
          eventsGallery.innerHTML =
            '<p style="color:red;">Failed to load events. Please try again later.</p>';
          console.error("Error loading events:", error);
        }
      }

      const eventUploadForm = document.getElementById("event-upload-form");
      if (eventUploadForm) {
        eventUploadForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitBtn = eventUploadForm.querySelector(
            'button[type="submit"]'
          );
          submitBtn.disabled = true;

          const formData = new FormData();
          formData.append(
            "title",
            document.getElementById("event-title").value.trim()
          );
          formData.append("date", document.getElementById("event-date").value);
          formData.append(
            "image",
            document.getElementById("event-image").files[0]
          );
          try {
            const resp = await fetch(`${BACKEND_URL}/api/events`, {
              method: "POST",
              body: formData,
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });
            if (checkAuthError(resp)) return;
            if (!resp.ok) throw new Error("Failed to upload event image");
            showNotification(
              "event-notification",
              "Event uploaded successfully."
            );
            eventUploadForm.reset();
            loadEvents();
          } catch (err) {
            showNotification(
              "event-notification",
              "Upload failed: " + err.message,
              false
            );
          } finally {
            submitBtn.disabled = false;
          }
        });
      }

      // Logout functionality
      const logoutBtn = document.getElementById("btn-logout");
      logoutBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("adminToken");
          window.location.href = "/admin-login.html";
        }
      });

      // Initial load of notices
      loadNotices();
    </script>
  </body>
</html>
